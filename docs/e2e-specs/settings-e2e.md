# 設定ページ E2Eテスト仕様書

生成日: 2026-01-18
対象ページ: `/settings`
権限レベル: ユーザー（認証必須）

---

## テスト環境

```yaml
URL: http://localhost:3347/settings
認証: 必須（ProtectedRoute）
テストアカウント:
  email: test@promptmanagement.local
  password: TestPass123!
```

---

## 統合テストでカバー済み（E2Eから除外）

- ✅ 認証エラー（401）: frontend/tests/integration/auth/auth.flow.test.ts
- ✅ バリデーション（400）: test-settings-api.js（データインポート時）
- ✅ API正常系:
  - タスク4.1: GET /api/statistics - 統計情報取得
  - タスク4.2: GET /api/export - データエクスポート
  - タスク4.3: POST /api/import - データインポート
  - タスク4.4: DELETE /api/account - アカウント削除（模擬）

**E2Eの役割**: UIを通じたユーザー操作フローのみを検証

---

## E2Eテスト項目一覧（UIフローのみ: 8項目）

| ID | テスト項目 | 期待結果 |
|----|----------|---------|
| E2E-SET-001 | ページアクセス・統計表示 | ログイン後 → /settings → 統計カード3つ（総プロンプト数、タグ数、お気に入り数）が表示される |
| E2E-SET-002 | 統計情報リアルタイム更新 | ページ初回表示時に最新の統計情報が表示される（ローディング表示 → 統計値表示） |
| E2E-SET-003 | データエクスポートフロー | エクスポートボタンクリック → JSONファイルダウンロード → ファイル名「prompts_export_YYYYMMDD.json」形式 |
| E2E-SET-004 | エクスポートデータ形式確認 | ダウンロードファイルを開く → version, exported_at, prompts配列が含まれる |
| E2E-SET-005 | データインポートフロー | ファイル選択 → インポート → 成功メッセージ表示 → 統計情報自動更新 |
| E2E-SET-006 | ログアウトフロー | ログアウトボタンクリック → ログインページ（/login）へリダイレクト → セッション削除確認 |
| E2E-SET-007 | アカウント削除確認ダイアログ | アカウント削除ボタンクリック → 確認ダイアログ表示 → 「削除」入力フィールド表示 |
| E2E-SET-008 | アカウント削除キャンセル | 確認ダイアログでキャンセルボタンクリック → ダイアログ閉じる → 設定ページに残る |

---

## 各テスト項目の詳細

### E2E-SET-001: ページアクセス・統計表示

**前提条件**:
- ログイン済み（test@promptmanagement.local）
- プロンプトが1件以上存在

**操作手順**:
1. ブラウザで http://localhost:3347/settings にアクセス
2. ページ読み込み完了を待つ

**期待結果**:
- ページタイトル「設定」が表示される
- 統計カード3つが表示される:
  - 「総プロンプト数」カード
  - 「タグ数」カード
  - 「お気に入り数」カード
- 各カードに数値が表示される

**検証ポイント**:
- MainLayoutコンポーネントが表示されるか
- 統計情報が正しく取得・表示されるか

---

### E2E-SET-002: 統計情報リアルタイム更新

**前提条件**:
- ログイン済み
- プロンプトが複数件存在

**操作手順**:
1. /settings ページにアクセス
2. ローディング表示を確認
3. 統計情報表示を確認

**期待結果**:
- 初回表示時にCircularProgressが表示される
- データ取得後、統計カードに数値が表示される
- 数値は実際のデータベースの値と一致する

**検証ポイント**:
- useEffect初回マウント時のgetStatistics()呼び出し
- ローディング状態管理の動作
- 統計情報の正確性

---

### E2E-SET-003: データエクスポートフロー

**前提条件**:
- ログイン済み
- プロンプトが1件以上存在

**操作手順**:
1. /settings ページにアクセス
2. 「データをエクスポート」ボタンをクリック
3. ファイルダウンロードを確認

**期待結果**:
- JSONファイルがダウンロードされる
- ファイル名形式: `prompts_export_YYYYMMDD.json`（例: prompts_export_20260118.json）
- ブラウザのダウンロード履歴に表示される

**検証ポイント**:
- exportData() API呼び出し
- Blob作成とダウンロード処理
- ファイル名生成ロジック

---

### E2E-SET-004: エクスポートデータ形式確認

**前提条件**:
- E2E-SET-003でエクスポートしたJSONファイル

**操作手順**:
1. ダウンロードしたJSONファイルを開く
2. データ構造を確認

**期待結果**:
```json
{
  "version": "1.0",
  "exported_at": "2026-01-18T12:34:56.789Z",
  "prompts": [
    {
      "id": "...",
      "title": "...",
      "description": "...",
      "content": "...",
      "tags": [...],
      "is_favorite": true/false,
      "created_at": "...",
      "updated_at": "..."
    }
  ]
}
```

**検証ポイント**:
- バージョン情報（"1.0"）の存在
- エクスポート日時（ISO8601形式）の存在
- prompts配列の存在と内容

---

### E2E-SET-005: データインポートフロー

**前提条件**:
- ログイン済み
- 有効なエクスポートJSONファイル

**操作手順**:
1. /settings ページにアクセス
2. 「ファイルを選択」ボタンをクリック
3. エクスポートJSONファイルを選択
4. 「データをインポート」ボタンをクリック

**期待結果**:
- Snackbarで成功メッセージ表示: 「データをインポートしました（X件）」
- 統計情報が自動的に更新される（loadStatistics()再呼び出し）
- インポート後のプロンプト数が増加

**検証ポイント**:
- ファイル選択UI（input[type="file"]）の動作
- importData() API呼び出し
- 成功後の統計情報リロード

---

### E2E-SET-006: ログアウトフロー

**前提条件**:
- ログイン済み

**操作手順**:
1. /settings ページにアクセス
2. 「ログアウト」ボタンをクリック

**期待結果**:
- ログインページ（/login）へリダイレクト
- 再度 /settings にアクセスすると /login へリダイレクト（セッション削除確認）

**検証ポイント**:
- authService.signOut() 呼び出し
- AuthContextのログアウト処理
- ProtectedRouteによるリダイレクト

---

### E2E-SET-007: アカウント削除確認ダイアログ

**前提条件**:
- ログイン済み

**操作手順**:
1. /settings ページにアクセス
2. 「アカウント削除」ボタンをクリック

**期待結果**:
- 確認ダイアログが表示される
- ダイアログタイトル: 「アカウント削除の確認」
- 警告メッセージ: 「この操作は取り消せません」
- 入力フィールド: 「削除」と入力してください
- ボタン2つ: 「キャンセル」「削除」

**検証ポイント**:
- Dialog UIコンポーネントの表示
- TextField入力フィールドの表示
- 削除ボタンの無効化状態（初期状態）

---

### E2E-SET-008: アカウント削除キャンセル

**前提条件**:
- ログイン済み
- E2E-SET-007で確認ダイアログ表示済み

**操作手順**:
1. 確認ダイアログの「キャンセル」ボタンをクリック

**期待結果**:
- ダイアログが閉じる
- 設定ページ（/settings）に残る
- アカウントは削除されない
- 統計情報は変更なし

**検証ポイント**:
- ダイアログの閉じる処理
- state管理（dialogOpen, deleteConfirmText）のリセット
- API呼び出しがないこと

---

## 実装の注意事項

### テストデータ準備
- 各テスト前にログイン状態を確認
- 統計情報テストには最低1件のプロンプトが必要
- インポートテストには有効なエクスポートファイルが必要

### クリーンアップ
- アカウント削除テストは実行しない（実際の削除は避ける）
- E2E-SET-007, E2E-SET-008でキャンセル動作のみテスト
- インポートしたデータは手動削除可能

### 並列実行制約
- 統計情報は共有リソースのため、テストは直列実行推奨
- ファイルダウンロードはブラウザ設定に依存

---

## 実行コマンド

```bash
# E2Eテスト実行
npx playwright test tests/e2e/settings.spec.ts

# ヘッドレスモードでの実行
npx playwright test tests/e2e/settings.spec.ts --headed

# デバッグモード
npx playwright test tests/e2e/settings.spec.ts --debug
```

---

## 成功基準

- ✅ 全8項目のテストがパス
- ✅ UIを通じた操作フローが正常動作
- ✅ 統合テストとの重複なし（API動作は統合テストでカバー済み）
- ✅ ユーザー体験の確認（ローディング表示、メッセージ表示、ダイアログ動作）
