# プロンプト作成・編集ページ E2Eテスト仕様書

生成日: 2026-01-18
対象ページ: `/prompt/new`, `/prompt/:id/edit`
権限レベル: ユーザー（ProtectedRoute）

---

## テスト環境

```yaml
URL:
  - 作成: http://localhost:3347/prompt/new
  - 編集: http://localhost:3347/prompt/:id/edit
認証: 必須（ProtectedRoute）
テストアカウント:
  email: test@promptmanagement.local
  password: TestPass123!
```

---

## 統合テストでカバー済み（E2Eから除外）

- ✅ 認証エラー（401）: frontend/tests/integration/auth/auth.flow.test.ts
- ✅ バリデーションエラー: API層でカバー（promptService.ts）
- ✅ CRUD正常系API: API統合完了（スライス3-A）
- ✅ タグ配列処理: サーバー側で実装済み
- ✅ お気に入りフラグ: DB層でBoolean型保証

---

## E2Eテスト項目一覧（UIフローのみ: 7項目）

| ID | テスト項目 | 期待結果 |
|----|----------|---------|
| E2E-FORM-001 | 新規作成ページアクセス | `/prompt/new`にアクセス → フォーム表示 → タイトル「プロンプト作成」表示 |
| E2E-FORM-002 | プロンプト新規作成フロー | タイトル入力 → 本文入力 → タグ追加（Enter） → お気に入りON → 保存 → 一覧ページ遷移 |
| E2E-FORM-003 | 編集ページアクセス・データ表示 | 一覧で編集ボタン → `/prompt/:id/edit`遷移 → タイトル「プロンプト編集」 → 既存データ表示 |
| E2E-FORM-004 | プロンプト編集フロー | 編集ページ → タイトル変更 → タグ削除（Chip×） → 保存 → 一覧ページ遷移 → 変更反映確認 |
| E2E-FORM-005 | タグ追加・削除UI操作 | タグ入力 → Enter → Chip表示 → Chip×クリック → 削除確認 |
| E2E-FORM-006 | キャンセル動作 | フォーム入力途中 → キャンセルボタン → 一覧ページ遷移 → データ保存されず |
| E2E-FORM-007 | 文字数カウント表示 | タイトル入力 → 「X / 200」更新 → 本文入力 → 「X / 100000」更新 |

---

## 実行コマンド

```bash
npx playwright test tests/e2e/prompt-form.spec.ts
```

---

## 統合テストカバレッジサマリー

### frontend/tests/integration/auth/auth.flow.test.ts でカバー済み
- 認証エラー（未ログイン → リダイレクト）
- セッション検証
- ログアウト後のアクセス制御

### API層（promptService.ts）でカバー済み
- タイトル必須バリデーション
- 本文必須バリデーション
- タグ配列の型安全性
- Supabase接続エラーハンドリング

### ページ固有のバリデーション（PromptFormPage.tsx）
- クライアント側バリデーション（88-99行目）
  - タイトル空文字チェック
  - 本文空文字チェック
- タグ制限バリデーション（141-148行目）
  - 最大10個制限
  - 重複タグチェック

---

## E2Eテストで検証すべきUIフロー詳細

### E2E-FORM-001: 新規作成ページアクセス
**操作フロー**:
1. ログイン済み状態でナビゲーションの「作成」をクリック
2. `/prompt/new`へ遷移

**期待結果**:
- ページタイトル「プロンプト作成」表示
- タイトル入力フィールド表示（プレースホルダー: 「プロンプトタイトルを入力してください...」）
- 本文入力フィールド表示（12行、プレースホルダー: 「プロンプト本文を入力してください...」）
- タグ入力フィールド表示（プレースホルダー: 「タグを入力してください...（Enterで追加）」）
- お気に入りスイッチ表示（初期値: OFF）
- キャンセルボタン・保存ボタン表示

---

### E2E-FORM-002: プロンプト新規作成フロー
**操作フロー**:
1. `/prompt/new`にアクセス
2. タイトル入力: 「E2Eテストプロンプト」
3. 本文入力: 「これはE2Eテスト用のプロンプトです。」
4. タグ入力 → 「TEST」入力 → Enter
5. タグ入力 → 「E2E」入力 → Enter
6. お気に入りスイッチをON
7. 保存ボタンクリック

**期待結果**:
- `/`（プロンプト一覧）へリダイレクト
- 一覧に「E2Eテストプロンプト」表示
- タグ「TEST」「E2E」表示
- お気に入りアイコン（★）表示

---

### E2E-FORM-003: 編集ページアクセス・データ表示
**操作フロー**:
1. プロンプト一覧で編集対象のプロンプトの編集ボタン（鉛筆アイコン）をクリック
2. `/prompt/:id/edit`へ遷移

**期待結果**:
- ページタイトル「プロンプト編集」表示
- タイトル入力フィールドに既存データ表示
- 本文入力フィールドに既存データ表示
- タグChipに既存タグ表示
- お気に入りスイッチが既存状態を反映

---

### E2E-FORM-004: プロンプト編集フロー
**操作フロー**:
1. 既存プロンプトの編集ページにアクセス（E2E-FORM-003）
2. タイトルを変更: 「編集済みプロンプト」
3. タグChipの×をクリックして1つ削除
4. 保存ボタンクリック

**期待結果**:
- `/`（プロンプト一覧）へリダイレクト
- 一覧で「編集済みプロンプト」表示
- 削除したタグが表示されない
- その他のフィールドは変更なし

---

### E2E-FORM-005: タグ追加・削除UI操作
**操作フロー**:
1. タグ入力フィールドに「TAG1」入力
2. Enter押下
3. タグ入力フィールドに「TAG2」入力
4. Enter押下
5. 「TAG1」のChip×クリック

**期待結果**:
- Enter押下後、即座にChip表示
- タグ入力フィールドがクリアされる
- Chip×クリック後、該当Chipが消える
- 他のChipは影響を受けない

---

### E2E-FORM-006: キャンセル動作
**操作フロー**:
1. `/prompt/new`にアクセス
2. タイトル入力: 「キャンセルテスト」
3. 本文入力: 「これは保存されません」
4. キャンセルボタンクリック

**期待結果**:
- `/`（プロンプト一覧）へリダイレクト
- 一覧に「キャンセルテスト」は表示されない
- データベースに保存されていない

---

### E2E-FORM-007: 文字数カウント表示
**操作フロー**:
1. タイトル入力フィールドに「テスト」（3文字）入力
2. 本文入力フィールドに「これはテストです。」（9文字）入力

**期待結果**:
- タイトル下の文字数表示が「3 / 200」に更新
- 本文下の文字数表示が「9 / 100000」に更新
- リアルタイムで入力に応じて更新される

---

## 技術的ポイント

### 非同期データ読み込み（useEffect）
- 編集モード時、ページマウント後に`getPromptById(id)`が実行される（54-58行目）
- ローディング状態の検証は不要（コンポーネントテストでカバー）

### タグ入力UI（Enterキー処理）
- `onKeyDown`イベントで`e.key === 'Enter'`を検知（136行目）
- Enter押下時に`e.preventDefault()`で改行防止
- タグ配列に追加後、入力フィールドをクリア（154行目）

### お気に入りスイッチ（Switch）
- MUI Switchコンポーネント（355-372行目）
- `checked`プロパティで状態制御
- `onChange`でBoolean値を直接`formData.is_favorite`に反映

### フォーム送信（handleSubmit）
- `e.preventDefault()`でデフォルト送信防止（89行目）
- クライアント側バリデーション実施後、API呼び出し
- 成功時は`navigate('/')`で一覧ページへリダイレクト（116行目）

---

## 実装時の注意事項（@E2Eテスト実装エージェント向け）

### 認証状態の準備
```typescript
// テスト開始前に必ずログイン状態を確保
await page.goto('http://localhost:3347/login');
await page.fill('input[type="email"]', 'test@promptmanagement.local');
await page.fill('input[type="password"]', 'TestPass123!');
await page.click('button[type="submit"]');
await page.waitForURL('http://localhost:3347/');
```

### フォーム要素のセレクタ
- タイトル: `input[placeholder*="プロンプトタイトルを入力"]`
- 本文: `textarea[placeholder*="プロンプト本文を入力"]`
- タグ入力: `input[placeholder*="タグを入力してください"]`
- お気に入りスイッチ: `.MuiSwitch-input`
- 保存ボタン: `button[type="submit"]:has-text("保存")`
- キャンセルボタン: `button:has-text("キャンセル")`

### タグChipの削除
```typescript
// タグChipの×ボタンをクリック
await page.click(`[data-testid="CancelIcon"][aria-label="delete TAG1"]`);
```

### データクリーンアップ
- 各テスト終了後、作成したプロンプトを削除すること
- テストデータは`unique-data-factory.ts`パターンを使用すること

---

## 品質基準

- ✅ E2E項目数: 7項目（5-10項目以内）
- ✅ UIフローのみ検証
- ✅ 統合テスト重複なし
- ✅ 認証エラーテスト除外
- ✅ バリデーションテスト除外（API層でカバー）
