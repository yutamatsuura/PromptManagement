# PromptManagement - 要件定義書

要件定義の作成原則
- **「あったらいいな」は絶対に作らない**
- **拡張可能性のための余分な要素は一切追加しない**
- **将来の「もしかして」のための準備は禁止**
- **今、ここで必要な最小限の要素のみ**

## 1. プロジェクト概要

### 1.1 成果目標
よく使うプロンプトをタグ付けで整理し、タイトル・説明・お気に入りで管理、リスト表示で一覧性を確保、ワンクリックコピーと簡単編集で即座に再利用できる個人用プロンプト管理システム。Supabaseによる永久保存とクラウド同期を実現。

### 1.2 成功指標

#### 定量的指標
1. プロンプトの保存から呼び出しまで3クリック以内で完了
2. タグ検索結果が1秒以内に表示される
3. ワンクリックで即座にクリップボードにコピー完了
4. お気に入りプロンプトに1クリックでアクセス可能
5. 編集ボタンから編集画面まで2クリック以内

#### 定性的指標
1. 毎日使いたくなるほど使い勝手が良い
2. プロンプトを探す時間が大幅に削減される
3. タグとお気に入りで直感的にプロンプトを整理できる
4. 説明を読むだけでプロンプトの用途がすぐわかる
5. 編集・削除が直感的で迷わない

## 2. システム全体像

### 2.1 主要機能一覧
- **プロンプト管理**: 作成・編集・削除・一覧表示
- **検索・フィルタリング**: タグ検索（AND/OR）、テキスト検索、お気に入り絞り込み
- **ワンクリックコピー**: Clipboard APIによる即座のコピー機能
- **データ永続化**: Supabaseによるクラウド保存と複数デバイス同期
- **認証**: Supabaseメール認証

### 2.2 ユーザーロールと権限
- **一般ユーザー**: 自分のプロンプトの全操作（作成・編集・削除・検索・コピー）

### 2.3 認証・認可要件
- 認証方式: Supabase Email + Password認証
- セキュリティレベル: 個人情報（メールアドレス）+ プロンプトデータ
- 管理機能: 不要（個人利用のため）

## 3. ページ詳細仕様

### 3.1 P-001: ログイン/新規登録ページ

#### 目的
Supabaseアカウントでログイン・新規登録し、個人データへの安全なアクセスを提供

#### 主要機能
- メールアドレス + パスワードでログイン
- 新規アカウント作成
- パスワードリセット機能

#### 必要な操作
| 操作種別 | 操作内容 | 必要な入力 | 期待される出力 |
|---------|---------|-----------|---------------|
| 作成 | 新規アカウント作成 | メールアドレス、パスワード | アカウント作成完了、確認メール送信 |
| 取得 | ログイン | メールアドレス、パスワード | 認証トークン、P-002へリダイレクト |
| 更新 | パスワードリセット | メールアドレス | リセットメール送信 |

#### 処理フロー
1. ユーザーがメールアドレス・パスワードを入力
2. Supabase認証APIで検証
3. 成功時: セッショントークン保存、プロンプト一覧ページへ遷移
4. 失敗時: エラーメッセージ表示

#### データ構造（概念）
```yaml
User:
  識別子: UUID（Supabase自動生成）
  基本情報:
    - email（必須）
    - password（ハッシュ化、必須）
  メタ情報:
    - created_at
    - last_sign_in_at
```

---

### 3.2 P-002: プロンプト一覧・検索ページ

#### 目的
プロンプトを効率的に検索・表示し、ワンクリックでコピーして即座に再利用する

#### 主要機能
- プロンプト一覧表示（リスト形式）
- タグによる絞り込み（複数タグAND/OR検索）
- テキスト検索（タイトル・説明・本文から検索）
- お気に入り表示切り替え
- ワンクリックコピーボタン
- 編集・削除ボタン（各プロンプト行に配置）

#### 必要な操作
| 操作種別 | 操作内容 | 必要な入力 | 期待される出力 |
|---------|---------|-----------|---------------|
| 取得 | プロンプト一覧取得 | ユーザーID（認証トークンから） | プロンプトリスト（降順: 更新日時） |
| 取得 | タグ検索 | 選択タグ配列、検索モード（AND/OR） | フィルタリングされたプロンプトリスト |
| 取得 | テキスト検索 | 検索クエリ文字列 | マッチするプロンプトリスト |
| 取得 | お気に入り絞り込み | なし | お気に入りフラグがtrueのプロンプトリスト |
| 更新 | クリップボードにコピー | プロンプトID | コピー成功/失敗ステータス |
| 削除 | プロンプト削除 | プロンプトID | 削除完了、リスト更新 |

#### 処理フロー
1. ページ読み込み時: Supabaseから全プロンプト取得
2. ユーザーがタグ選択/テキスト入力/お気に入り切り替え
3. クライアント側でリアルタイムフィルタリング（useMemo使用）
4. コピーボタンクリック: Clipboard APIで本文をコピー
5. 編集ボタンクリック: P-003へ遷移（プロンプトID付き）
6. 削除ボタンクリック: 確認ダイアログ → Supabaseから削除

#### データ構造（概念）
```yaml
Prompt:
  識別子: UUID
  基本情報:
    - title（必須、最大200文字）
    - description（任意、最大500文字）
    - content（必須、最大10000文字）
    - tags（配列、最大10個）
    - is_favorite（真偽値）
  メタ情報:
    - created_at
    - updated_at
    - user_id（外部キー）
  関連:
    - User（多対一）
```

---

### 3.3 P-003: プロンプト作成・編集ページ

#### 目的
プロンプトの新規作成と既存プロンプトの編集により、データの蓄積と更新を可能にする

#### 主要機能
- タイトル入力
- 説明入力
- プロンプト本文入力（マルチラインテキストエリア）
- タグ入力（tagifyによるオートコンプリート）
- お気に入り設定（トグルボタン）
- 保存・キャンセルボタン

#### 必要な操作
| 操作種別 | 操作内容 | 必要な入力 | 期待される出力 |
|---------|---------|-----------|---------------|
| 取得 | 既存プロンプト取得（編集時） | プロンプトID | プロンプトデータ |
| 取得 | 既存タグ一覧取得 | ユーザーID | タグ配列（オートコンプリート用） |
| 作成 | 新規プロンプト保存 | タイトル、説明、本文、タグ、お気に入り | プロンプトID、P-002へリダイレクト |
| 更新 | プロンプト更新 | プロンプトID、更新データ | 更新完了、P-002へリダイレクト |

#### 処理フロー
1. 新規作成: 空フォーム表示
2. 編集: プロンプトIDからデータ取得、フォームに反映
3. ユーザーが入力
4. 保存ボタンクリック:
   - バリデーション（タイトル・本文必須）
   - Supabaseへ保存/更新
   - 成功: P-002へ遷移
   - 失敗: エラーメッセージ表示
5. キャンセルボタン: P-002へ遷移（未保存データ破棄）

#### データ構造（概念）
```yaml
Prompt:
  識別子: UUID
  基本情報:
    - title（必須、最大200文字）
    - description（任意、最大500文字）
    - content（必須、最大10000文字）
    - tags（配列、最大10個）
    - is_favorite（真偽値、デフォルト: false）
  メタ情報:
    - created_at（自動設定）
    - updated_at（自動更新）
    - user_id（認証ユーザーから自動設定）
```

---

### 3.4 P-004: 設定ページ

#### 目的
データ管理とアカウント設定により、安全性確保と長期利用の基盤を提供

#### 主要機能
- 統計情報表示（総プロンプト数、タグ数、お気に入り数）
- データエクスポート（JSON形式でダウンロード）
- データインポート（JSONファイルアップロード）
- ログアウト
- アカウント削除（確認ダイアログ付き）

#### 必要な操作
| 操作種別 | 操作内容 | 必要な入力 | 期待される出力 |
|---------|---------|-----------|---------------|
| 取得 | 統計情報取得 | ユーザーID | プロンプト数、タグ数、お気に入り数 |
| 取得 | データエクスポート | ユーザーID | JSON形式ファイルダウンロード |
| 作成 | データインポート | JSONファイル | インポート完了、統計更新 |
| 削除 | ログアウト | なし | セッション削除、P-001へリダイレクト |
| 削除 | アカウント削除 | 確認入力 | 全データ削除、P-001へリダイレクト |

#### 処理フロー
1. 統計情報: Supabaseから集計クエリ実行、表示
2. エクスポート:
   - 全プロンプトデータ取得
   - JSON形式に変換
   - Blobとしてダウンロード
3. インポート:
   - JSONファイルアップロード
   - バリデーション（形式チェック）
   - Supabaseへ一括挿入
4. ログアウト: Supabase signOut() 実行
5. アカウント削除:
   - 確認ダイアログ（「削除」と入力）
   - 全プロンプト削除 → ユーザーアカウント削除

#### データ構造（概念）
```yaml
Statistics:
  total_prompts: 数値
  total_tags: 数値
  favorite_count: 数値

ExportData:
  version: "1.0"
  exported_at: ISO8601日時
  prompts: Prompt配列
```

---

## 4. データ設計概要

### 4.1 主要エンティティ

```yaml
User:
  概要: Supabase認証ユーザー
  主要属性:
    - id (UUID、主キー)
    - email (文字列、一意)
    - created_at (タイムスタンプ)
  関連:
    - Prompt（一対多）

Prompt:
  概要: 保存されたプロンプト情報
  主要属性:
    - id (UUID、主キー)
    - user_id (UUID、外部キー)
    - title (文字列、最大200文字)
    - description (文字列、最大500文字、NULL可)
    - content (テキスト、最大10000文字)
    - tags (文字列配列、最大10要素)
    - is_favorite (真偽値、デフォルト: false)
    - created_at (タイムスタンプ)
    - updated_at (タイムスタンプ)
  関連:
    - User（多対一）
```

### 4.2 エンティティ関係図
```
User ─── Prompt (一対多)
```

### 4.3 バリデーションルール
```yaml
title:
  - ルール: 1文字以上200文字以内、必須
  - 理由: プロンプトの識別に必要

content:
  - ルール: 1文字以上10000文字以内、必須
  - 理由: プロンプト本文は必須

tags:
  - ルール: 配列、最大10要素、各要素50文字以内
  - 理由: 検索効率とUIの見やすさを両立

email:
  - ルール: 有効なメール形式
  - 理由: 認証とアカウント識別のため

password:
  - ルール: 8文字以上
  - 理由: Supabaseデフォルトセキュリティ要件
```

## 5. 制約事項

### 外部API制限
- **Supabase無料枠**: データベース容量500MB、月間アクティブユーザー50,000人（個人利用では十分）
- **Vercel無料枠**: 帯域幅100GB/月、ビルド時間6,000分/月（個人利用では十分）

### 技術的制約
- **Clipboard API**: HTTPS環境必須（localhost除く）、ユーザージェスチャー（クリック）必須
- **ブラウザ対応**: モダンブラウザ（Chrome 76+、Firefox 127+、Safari 13.1+、Edge 79+）

## 5.1 セキュリティ要件

### 基本方針
本プロジェクトは **CVSS 3.1（Common Vulnerability Scoring System）** に準拠したセキュリティ要件を満たすこと。

CVSS 3.1の評価観点:
- **機密性（Confidentiality）**: 不正アクセス防止、データ暗号化
- **完全性（Integrity）**: データ改ざん防止、入力検証
- **可用性（Availability）**: DoS対策、冗長化

詳細な診断と改善は、Phase 11（本番運用診断）で @本番運用診断オーケストレーター が実施します。

---

### プロジェクト固有の必須要件

**認証機能（必須）**:
- ✅ ブルートフォース攻撃対策（Supabase標準実装）
- ✅ パスワードポリシー（8文字以上、Supabase標準）
- ✅ セッション管理（Supabase JWT、自動タイムアウト）
- ✅ CSRF対策（Supabase標準実装）

**データ保護**:
- ✅ Row Level Security（RLS）による個人データ分離
- ✅ SSL/TLS通信（Supabase標準、Vercel標準）

**その他の一般要件**:
- ✅ HTTPSの強制（Vercel自動設定）
- ✅ セキュリティヘッダー設定（本番環境）
- ✅ 入力値のサニタイゼーション
- ✅ エラーメッセージでの情報漏洩防止

---

### 運用要件：可用性とヘルスチェック

**Supabase接続確認**:
- フロントエンドからSupabaseへの接続テスト
- エラー時のユーザーフィードバック

## 6. 技術スタック

**フロントエンド**:
- React 18
- TypeScript 5
- MUI v6（UIコンポーネント）
- Zustand（状態管理）
- React Router v6（ルーティング）
- Vite 5（ビルドツール）

**バックエンド・データベース**:
- Supabase（PostgreSQL、認証、リアルタイム機能）
- @supabase/supabase-js（クライアントライブラリ）

**専用ライブラリ**:
- @yaireo/tagify（タグ入力UI）

**インフラ**:
- Vercel（フロントエンドホスティング）
- Supabase（データベース・認証）

## 7. 必要な外部サービス・アカウント

### 必須サービス
| サービス名 | 用途 | 取得先 | 備考 |
|-----------|------|--------|------|
| Supabase | データベース・認証 | https://supabase.com | 無料枠500MB、クレカ登録不要 |
| Vercel | フロントエンドホスティング | https://vercel.com | 無料、GitHubアカウントで登録可能 |

### オプションサービス
なし

## 8. 今後の拡張予定

**原則**: 拡張予定があっても、必要最小限の実装のみを行う

- 「あったらいいな」は実装しない
- 拡張可能性のための余分な要素は追加しない
- 将来の「もしかして」のための準備は禁止
- 今、ここで必要な最小限の要素のみを実装

拡張が必要になった時点で、Phase 11: 機能拡張オーケストレーターを使用して追加実装を行います。

（拡張候補）
- AIによるプロンプト自動生成
- チーム共有機能
- プロンプトテンプレート機能
- 使用頻度の自動追跡
